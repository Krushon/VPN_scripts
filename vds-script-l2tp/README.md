# vds-script-l2tp
(bash scripts for debian 10)<br>
<br>
**Описание скриптов:**<br>
Установка и настройка L2TP + IPsec<br>

<br>

**Содержимое скриптов:**<br>
0 - Подготовка vds-машины: загрузка скриптов, обновление ssh-конфига. Подразумевается наличие сгенерированного ssh-ключа authorized_keys (см. <a href="https://github.com/Krushon/VPN_scripts/wiki/1.-%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-ssh">wiki</a>).<br>
1 - Обновление ОС. Выполняется проверка версии дистрибутива. Если версия 8 или 9, то обновляется до 10. Если 10, то просто обновляется.<br>
2 - Установка необходимого ПО.<br>
3 - Генерация конфигов, перезапуск служб.<br>
4 - Добавление пользователя и PSK-ключа.<br>
<br>

**Предлагаемые пакеты для установки:**<br>
`mc` - MidnightCommander - полноэкранный текстовый файловый менеджер<br>
`chrony` - универсальная реализация протокола сетевого времени<br>
`fail2ban` - отслеживает файлы журнала и временно или постоянно запрещает доступ нарушителям<br>
`mutt` - текстовый mailreader поддерживает MIME, GPG, PGP и потоковую обработку<br>
`mailutils` - утилиты для обработки почты<br>
`gpgsm` - защитник конфиденциальности, S/MIME-версия<br>
`iptables-persistent` - загрузчик для правил netfilter, плагин iptables<br>
`xl2tpd` - реализация протокола туннелирования второго уровня (L2TP)<br>
`libgmp3-dev` - библиотека инструментов арифметических вычислений с повышенной точностью<br>
`gawk` - язык шаблонного сканирования и обработки awk<br>
`flex` - генератор быстрого лексического анализатора<br>
`bison` - YACC-совместимый генератор синтаксического анализатора<br>
`make` - утилита управления компиляцией<br>
`libc6-dev` - библиотеки для разработки и заголовочные файлы для GNU C<br>
`devscripts` - скрипты, облегчающие жизнь сопровождающего пакета debian<br>
`libssl-dev` - файлы разработки ssl<br>
`openswan` - реализация IPsec для Linux<br>
<br>
**Работа со скриптами:**
1. На vds загружаем скрипт 0_script-prepare.sh и ключ authorized_keys через терминал.<br>
`$ scp 0_script-prepare.sh authorized_keys root@айпи:~`

ИЛИ

скачиваем 0_script-prepare.sh напрямую из репозитория:<br>
`# wget https://raw.githubusercontent.com/Krushon/VPN_scripts/master/vds-script-l2tp/0_script-prepare.sh`

2. Подключаемся к vds по ssh, устанавливаем права на запуск скрипта, запускаем скрипт.

`ssh root@айпи`<br>
`chmod +x 0_script-prepare.sh`<br>
`./0_script-prepare.sh`<br>

Обновится файл sshd_config для подключения к vds по ssh с ключом. Скачаются скрипты установки ПО и генерации сертификатов с github.

3. Подлючаемся обратно и запускаем скрипты по очереди.

`ssh root@айпи -i ключ.key`<br>
`./1_script-upgrade.sh`<br>
`./2_script-install.sh`<br>

Если нужно настроить ntp на свой сервер синхронизации времени, то просто добавьте строку с адресом в файл /etc/chrony/chrony.conf в виде: server айпи iburst, а pool закомментируйте:<br>
`cp /etc/chrony/chrony.conf /etc/chrony/chrony.conf.bak` (делаем бэкап конфига)<br>
`sed -i '3s/.*pool.*/server АЙПИ iburst/' /etc/chrony/chrony.conf` (заменяем пул на свой сервер)<br>
`systemctl restart chrony` (перезапускаем службу)<br>
`chronyc sourcestats` (проверяем статус)<br>

`./3_script-conf.sh`<br>

Вся система будет обновлена, установится ПО, сгенерируются конфигурационные файлы.<br>
Скрипты 0-3 запускаются один раз. Больше не требуется.<br>

4. Для создания нового пользователя и его ключа запускаем скрипт 4_add-client.sh.<br>
`./4_add-client.sh`