# Организация OpenVPN-сервера для удалённого подключения
Скрипты автоматизации организации OpenVPN-сервера и выдачи сертификатов для пользователей<br>
<br>
Подразумевается, что используется ОС debian.<br>
<br>
**Описания скриптов:**<br>
0_script-prepare.sh - Подготовка машины: загрузка скриптов, опционально - обновление ssh-конфига.<br>
--- раскомментируйте блок в скрипте для подключения по ssh с ключом. (Подразумевается наличие сгенерированного ssh-ключа authorized_keys).<br>
1_script-upgrade.sh - Обновление ОС. Выполняется проверка версии дистрибутива. Если версия 8, то обновляется до 9. Если 9, то просто обновляется.<br>
--- Опционально: в дальнейшем может использоваться для обновления ОС и ПО.<br>
2_script-install.sh - Установка ПО: openvpn, mc, net-tools, ntp, mailutils и mutt.<br>
3_script-cert.sh - Генерация сертификатов, подготовка файлов - iptables, конфиги и прочее.<br>
add-vpn-user - скрипт на выдачу сертификатов пользователю.<br>
del-vpn-user - скрипт, отзывающий выданный сертификат пользователя.<br>
<br>
**Работа скриптов:**
1. На сервер загружаем скрипт 0_script-prepare.sh (опционально: и ключ authorized_keys) через терминал.
```bash
scp 0_script-prepare.sh authorized_keys root@айпи:~
```
2. Подключаемся к сервреу по ssh, устанавливаем права на запуск скрипта (опционально: раскомментируем блок для подключения по ключу) запускаем скрипт.
```bash
ssh root@айпи
chmod +x 0_script-prepare.sh
./0_script-prepare.sh
```
Скачаются скрипты установки ПО и генерации сертификатов с github.<br>
---Если был раскомментирован блок подключения по ключу, то обновится файл sshd_config для подключения к vds по ssh с ключом.<br>

3. Запускаем скрипты по очереди.
```bash
./1_script-upgrade.sh
./2_script-install.sh
./3_script-cert.sh
```

(или можно запустить всю пачку)
```
./1_script-upgrade.sh && ./2_script-install.sh && ./3_script-cert.sh
```
В скрипте 3_script-cert.sh потребуется указать название, е-мейл и номер tun.

Вся система будет обновлена, установится ПО, сгенерируются сертификаты.<br>
При генерации сертификатов скрипт сам нажимает в нужных местах Enter и вводит 'y'.

4. Закрываем все подключения по ssh, кроме своего.
```bash
mcedit /etc/iptables.rules
```
Раскомментируем блоки с айпишниками, указываем свои.<br>

5. Выписываем сертификат для пользователя.
```bash
./add-vpn-user _пользователь_
```
Сгенерированный сертификат _пользователя_ будет отправлен вам на почту, которую указали в начале скрипта.<br>
По окончании указанного срока действия сертификат будет отозван и удалён.<br>

6. Отзываем сертификат пользователя.
```bash
./del-vpn-user _пользователь_
```
Сгенерированный сертификат _пользователя_ будет отозван, файлы удалены.<br>
