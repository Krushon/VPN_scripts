# Организация OpenVPN-сервера для удалённого подключения
(bash scripts for debian 10)<br>
<br>
**Описание скриптов:**<br>
Скрипты автоматизации процесса настройки маршрутных файлов и OpenVPN-сертификатов для постройки одинарного туннеля.<br>
<br>
**Содержимое скриптов:**<br>
`0_script-prepare.sh` - Подготовка машины: загрузка скриптов, опционально - обновление ssh-конфига.<br>
--- раскомментируйте блок в скрипте для подключения по ssh с ключом. (Подразумевается наличие сгенерированного ssh-ключа authorized_keys) (см. <a href="https://github.com/Krushon/VPN_scripts/wiki/1.-%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-ssh">wiki</a>).<br>
`1_script-upgrade.sh` - Обновление ОС (выполняется проверка версии дистрибутива).<br>
--- Опционально: в дальнейшем может использоваться для обновления ОС и ПО.<br>
`2_script-install.sh` - Установка ПО: openvpn, mc, chrony, nftables, mutt и mailutils.<br>
`3_script-cert.sh` - Генерация серверных сертификатов, подготовка файлов (файрвол, конфиги и прочее).<br>
`add-vpn-user` - скрипт на выдачу сертификатов пользователю.<br>
`del-vpn-user` - скрипт, отзывающий выданный сертификат пользователя.<br>
<br>
**Предлагаемый софт для установки:**<br>
`openvpn` - приложение для создания безопасного ip-туннеля через единый udp- или tcp-порт<br>
`mc` - MidnightCommander - полноэкранный текстовый файловый менеджер<br>
`chrony` - клиент для установки системного времени и серверов NTP<br>
`nftables` - Netfilter Tables - механизм для управления файрволом (замена устаревшему iptables).<br>
`mutt` - текстовый почтовик, поддерживает MIME, GPG, PGP и потоковую обработку.<br>
`mailutils` - это богатая и мощная независимая от протокола почтовая платформа.<br>
<br>

**Работа со скриптами:**
1. На сервер загружаем скрипт `0_script-prepare.sh` (опционально: и ключ authorized_keys) через терминал.<br>
```bash
scp 0_script-prepare.sh authorized_keys root@айпи:~
```

ИЛИ

скачиваем `0_script-prepare.sh` напрямую из репозитория:
```bash
wget https://raw.githubusercontent.com/Krushon/VPN_scripts/master/openvpn-server-script/0_script-prepare.sh
```

2. Подключаемся к серверу по ssh, устанавливаем права на запуск скрипта, запускаем скрипт.
```bash
ssh root@айпи
chmod +x 0_script-prepare.sh
./0_script-prepare.sh
```

Скачаются скрипты установки ПО и генерации сертификатов с github.<br>
---Если был раскомментирован блок подключения по ключу, то обновится файл `sshd_config` для подключения к серверу по ssh с ключом.<br>

3. Запускаем скрипты по очереди.<br>
```bash
./1_script-upgrade.sh
./2_script-install.sh
```

Если нужно настроить ntp на свой сервер синхронизации времени, то просто добавьте строку с адресом в файл `/etc/chrony/chrony.conf` в виде: server айпи iburst, а pool закомментируйте:<br>
`cp /etc/chrony/chrony.conf /etc/chrony/chrony.conf.bak` (делаем бэкап конфига)<br>
`sed -i '3s/.*pool.*/server АЙПИ iburst/' /etc/chrony/chrony.conf` (заменяем пул на свой сервер)<br>
`systemctl restart chrony` (перезапускаем службу)<br>
`chronyc sourcestats` (проверяем статус)<br>

<s>`cp /etc/ntp.conf /etc/ntp.conf.bak` (делаем бэкап конфига)<br>
`sed -i '18s/#server ntp.your-provider.example/server АЙПИ iburst/' /etc/ntp.conf` (указываем свой сервер)<br>
`sed -i 's/.*debian.pool/# \0/' /etc/ntp.conf` (комментируем все строки с пулами адресов)<br>
`systemctl restart ntp` (перезапускаем службу)<br></s>

`./3_script-cert.sh`<br>

В скрипте `3_script-cert.sh` потребуется указать название, е-мейл и номер tun.

Вся система будет обновлена, установится ПО, сгенерируются сертификаты.<br>
*При генерации сертификатов необходимо будет указать название компании, емэйл, протокол подключения, номер туннеля и порт ssh*<br>
При генерации сертификатов скрипт сам нажимает в нужных местах Enter и вводит 'yes'.


4. Закрываем все подключения по ssh, кроме своего.
```bash
mcedit /etc/iptables.rules
```
Раскомментируем блоки с айпишниками, указываем свои.<br>

5. Выписываем сертификат для пользователя.
```bash
./add-vpn-user _пользователь_
```
Сгенерированный сертификат _пользователя_ будет отправлен вам на почту, которую указали в начале скрипта.<br>
По окончании указанного срока действия сертификат будет отозван и удалён.<br>

6. Отзываем сертификат пользователя.
```bash
./del-vpn-user _пользователь_
```
Сгенерированный сертификат _пользователя_ будет отозван, файлы удалены.<br>
