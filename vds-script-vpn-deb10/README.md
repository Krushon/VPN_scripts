# vds-script-vpn-deb10
(bash scripts for debian 10)<br>
<br>
**Описание скриптов:**<br>
Скрипты автоматизации процесса настройки маршрутных файлов и OpenVPN-сертификатов для постройки одинарного туннеля.<br>
<br>
**Схема работы:**<br>
На vds организуется сервер openvpn, на шлюзе - клиент openvpn. На виртуальной машине в настройках сети указывается наш шлюз.<br>
На шлюзе настроен маршрут, по которому вм выходит в интернет и обратно.<br>
<br>
Пользователь --> OpenVPN-клиент --> OpenVPN-сервер --> Интернет<br>
возврат трафика:<br>
Пользователь <-- OpenVPN-клиент <-- OpenVPN-сервер <-- Интернет<br>
<br>
Более определённый пример:<br>
Виртуальная машина <--> Шлюз <--> VDS с внешним ip
<br><br>
Шлюз один. Виртуальных (или обычных) машин внутри сети может быть много. Для каждой машины нужен отдельный vds со своим внешним ip.
<br><br>
Все скрипты настроены на debian 10 и доступом по root через ssh с ключом.<br>
<br>
**Содержимое скриптов:**<br>
0 - Подготовка vds-машины: загрузка скриптов, обновление ssh-конфига. Подразумевается наличие сгенерированного ssh-ключа authorized_keys (см. <a href="https://github.com/Krushon/VPN_scripts/wiki/1.-%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-ssh">wiki</a>).<br>
1 - Обновление ОС. Выполняется проверка версии дистрибутива. Если версия 8 или 9, то обновляется до 10. Если 10, то просто обновляется.<br>
2 - Установка ПО: openvpn, asterisk, mc, chrony, fail2ban, nftables.<br>
3 - Генерация сертификатов, подготовка файлов.<br>
script-delete - Удаление ПО и сертификатов.<br>
<br>
**Предлагаемый софт для установки:**<br>
`openvpn` - приложение для создания безопасного ip-туннеля через единый udp- или tcp-порт<br>
`asterisk` - телефонная станция и набор инструментальных средств для телефонии<br>
`mc` - MidnightCommander - полноэкранный текстовый файловый менеджер<br>
`chrony` - клиент для установки системного времени и серверов NTP<br>
`fail2ban` - отслеживает файлы журнала и временно или постоянно запрещает доступ нарушителям<br>
`nftables` - Netfilter Tables - механизм для управления файрволом (замена устаревшему iptables).<br>
<br>
**Работа со скриптами:**
1. На vds загружаем скрипт 0_script-prepare.sh и ключ authorized_keys через терминал.<br>
`$ scp 0_script-prepare.sh authorized_keys root@айпи:~`

ИЛИ

скачиваем 0_script-prepare.sh напрямую из репозитория:<br>
`# wget https://raw.githubusercontent.com/Krushon/VPN_scripts/master/vds-script-vpn-deb10/0_script-prepare.sh`

2. Подключаемся к vds по ssh, устанавливаем права на запуск скрипта, запускаем скрипт.

`ssh root@айпи`<br>
`chmod +x 0_script-prepare.sh`<br>
`./0_script-prepare.sh`<br>

Обновится файл sshd_config для подключения к vds по ssh с ключом. Скачаются скрипты установки ПО и генерации сертификатов с github.

Запускаем скрипты по очереди.<br>
`./1_script-upgrade.sh`<br>
`./2_script-install.sh`<br>

Если нужно настроить ntp на свой сервер синхронизации времени, то просто добавьте строку с адресом в файл /etc/chrony/chrony.conf в виде: server айпи iburst, а pool закомментируйте:<br>
`cp /etc/chrony/chrony.conf /etc/chrony/chrony.conf.bak` (делаем бэкап конфига)<br>
`sed -i '3s/.*pool.*/server АЙПИ iburst/' /etc/chrony/chrony.conf` (заменяем пул на свой сервер)<br>
`systemctl restart chrony` (перезапускаем службу)<br>
`chronyc sourcestats` (проверяем статус)<br>

<s>`cp /etc/ntp.conf /etc/ntp.conf.bak` (делаем бэкап конфига)<br>
`sed -i '18s/#server ntp.your-provider.example/server АЙПИ iburst/' /etc/ntp.conf` (указываем свой сервер)<br>
`sed -i 's/.*debian.pool/# \0/' /etc/ntp.conf` (комментируем все строки с пулами адресов)<br>
`systemctl restart ntp` (перезапускаем службу)<br></s>

`./3_script-cert.sh`<br>

Вся система будет обновлена, установится ПО, сгенерируются сертификаты.<br>
*При генерации сертификатов необходимо будет указать название компании, емэйл, протокол подключения, номер туннеля и порт ssh*<br>
При генерации сертификатов скрипт сам нажимает в нужных местах Enter и вводит 'yes'.

**Работа с сертификатами на шлюзе:**

4. Заходим на шлюз и копируем из VDS/etc/openvpn/user/ все файлы

`scp -P порт_ssh -i ключ.key root@айпи:/etc/openvpn/user/компания.tar /root/компания`

*Адрес туннеля по-умолчанию имеет адрес 10.**1**.tun.x для шлюза1. Для шлюза2 адрес нужно будет пока поменять вручную на 10.**2**.tun.x.*

5. Если планируется множественное использование сертификатов, то для упрощения обработки можно сделать скрипт на копирование.

`nano copy-vds-ca.sh`
```bash
#!/bin/bash
mkdir "$1"
scp -P порт_ssh -i ключ.key root@"$1":/etc/openvpn/user/"$1".tar .
mv "$1".tar ~/"$1"
tar -xvf ~/"$1"/"$1".tar -C ~/"$1"
chmod 766 ~/"$1"/"$1"-up.sh
```
Скрипт при вызове `./copy-vds-ca.sh company1` создаст папку, скопирует и распакует архив с сертификатами.
Далее эти сертификаты копируем в папку /etc/openvpn/company1, файл @company1-user.conf переносим в /etc/openvpn.
